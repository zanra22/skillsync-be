# Remember Me Feature - Testing Guide

## üéØ Testing Objectives

Verify that:
1. ‚úÖ Session cookies (remember_me=False) are deleted when browser closes
2. ‚úÖ Persistent cookies (remember_me=True) survive browser restarts
3. ‚úÖ Access tokens are stored in memory only (not in cookies/localStorage)
4. ‚úÖ HTTP-only cookies cannot be accessed by JavaScript
5. ‚úÖ Logout clears all cookies correctly
6. ‚úÖ Token rotation works on refresh

---

## üöÄ Quick Testing Plan (5 Minutes)

### Test 1: Session Cookie (Remember Me = OFF)
**Time**: 2 minutes

```bash
1. Start both servers:
   # Terminal 1 - Backend
   cd skillsync-be
   python manage.py runserver

   # Terminal 2 - Frontend
   cd skillsync-fe
   bun dev

2. Open browser: http://localhost:3000/auth/login

3. Login WITHOUT checking "Remember Me"
   - Email: test@skillsync.com
   - Password: [your password]
   - Remember Me: UNCHECKED ‚ùå

4. Check DevTools ‚Üí Application ‚Üí Cookies ‚Üí localhost
   Expected:
   ‚úÖ refresh_token: NO "Expires" field (session cookie)
   ‚úÖ client_fp: NO "Expires" field
   ‚úÖ fp_hash: NO "Expires" field
   ‚ùå NO "auth-token" cookie (removed in Phase 1)

5. Close ALL browser windows (Ctrl+Shift+W or close entirely)

6. Reopen browser ‚Üí http://localhost:3000
   Expected:
   ‚ùå NOT logged in (redirected to login page)
   ‚úÖ Session ended when browser closed
```

**Expected Result**: ‚úÖ PASS - User must login again after browser close

---

### Test 2: Persistent Cookie (Remember Me = ON)
**Time**: 2 minutes

```bash
1. Open browser: http://localhost:3000/auth/login

2. Login WITH "Remember Me" checked
   - Email: test@skillsync.com
   - Password: [your password]
   - Remember Me: CHECKED ‚úÖ

3. Check DevTools ‚Üí Application ‚Üí Cookies ‚Üí localhost
   Expected:
   ‚úÖ refresh_token: "Expires" = ~30 days from now
   ‚úÖ client_fp: "Expires" = ~30 days from now
   ‚úÖ fp_hash: "Expires" = ~30 days from now

4. Check Console logs:
   Expected:
   ‚úÖ "üîê Setting PERSISTENT cookies: 30 days"

5. Close ALL browser windows

6. Reopen browser ‚Üí http://localhost:3000
   Expected:
   ‚úÖ Still logged in (session restored)
   ‚úÖ Redirected to dashboard (no login required)
   ‚úÖ Console shows: "‚úÖ Session restored successfully"
```

**Expected Result**: ‚úÖ PASS - User stays logged in after browser restart

---

### Test 3: Memory-Only Access Token
**Time**: 1 minute

```bash
1. Login successfully (with or without Remember Me)

2. Open DevTools ‚Üí Console
   Type: document.cookie
   Expected:
   ‚ùå Should NOT show "auth-token" or "access_token"
   ‚úÖ May show "refresh_token" BUT with [HttpOnly] indicator (cannot access value)

3. Type: localStorage.getItem('accessToken')
   Expected:
   ‚ùå null (not in localStorage)

4. Type: sessionStorage.getItem('accessToken')
   Expected:
   ‚ùå null (not in sessionStorage)

5. Check React DevTools ‚Üí Components ‚Üí AuthContext
   Expected:
   ‚úÖ authState.accessToken: "eyJhbGciOiJI..." (in memory)
```

**Expected Result**: ‚úÖ PASS - Access token ONLY in React state (memory)

---

## üß™ Automated Backend Testing

### Test Script: `skillsync-be/test_remember_me.py`

**Already created in backend guide!** Run it:

```bash
cd skillsync-be
python test_remember_me.py
```

**Expected Output**:
```
üß™ Testing Remember Me Backend Implementation

‚úÖ Using existing test user

üîë Generated tokens:
   Access token (first 50 chars): eyJhbGciOiJIUzI1NiIs...
   Refresh token (first 50 chars): eyJhbGciOiJIUzI1NiIs...

üìã Test 1: Session Cookie (remember_me=False)
------------------------------------------------------------
üîê Setting SESSION cookies (browser close = logout)
   Cookie max-age: None
   ‚úÖ PASS: Session cookie (no max-age)

üìã Test 2: Persistent Cookie (remember_me=True)
------------------------------------------------------------
üîê Setting PERSISTENT cookies: 30 days
   Cookie max-age: 2592000 seconds
   ‚úÖ PASS: Persistent cookie (30 days)

üìã Test 3: Cookie Security Attributes
------------------------------------------------------------
   HttpOnly: True
   SameSite: Strict
   Path: /
   ‚úÖ PASS: All security attributes correct

============================================================
üéâ Testing complete!
```

---

## üîç Detailed Testing Checklist

### ‚úÖ Backend Tests

Run these tests to verify backend implementation:

```bash
cd skillsync-be

# Test 1: JWT authentication flow
python test_jwt_auth.py

# Test 2: Complete authentication flow
python test_complete_flow.py

# Test 3: Remember Me functionality (most important)
python test_remember_me.py

# Test 4: Run Django unit tests
python manage.py test auth
```

---

### ‚úÖ Frontend Manual Tests

#### Test A: Cookie Inspection
```bash
1. Login with Remember Me = ON
2. Open DevTools ‚Üí Application ‚Üí Cookies
3. Verify each cookie:

refresh_token:
‚úÖ Value: Long JWT string
‚úÖ Domain: localhost
‚úÖ Path: /
‚úÖ Expires: ~30 days from now
‚úÖ HttpOnly: ‚úì (checkmark)
‚úÖ Secure: ‚úì (if HTTPS, otherwise -)
‚úÖ SameSite: Strict

client_fp:
‚úÖ Value: Random string (device fingerprint)
‚úÖ HttpOnly: ‚úì
‚úÖ Expires: ~30 days from now

fp_hash:
‚úÖ Value: SHA-256 hash
‚úÖ HttpOnly: ‚úì
‚úÖ Expires: ~30 days from now

‚ùå auth-token: Should NOT exist (removed in Phase 1)
```

---

#### Test B: Session Restoration on Page Refresh
```bash
1. Login successfully (with or without Remember Me)
2. Navigate to any page (e.g., /dashboard)
3. Press F5 or Ctrl+R to refresh
4. Open DevTools ‚Üí Console

Expected logs:
‚úÖ "üîç Checking for existing session..."
‚úÖ "üîÑ Refreshing access token..."
‚úÖ "‚úÖ Token refresh successful"
‚úÖ "üîê New access token stored in memory"

Expected behavior:
‚úÖ Page reloads
‚úÖ User stays logged in (no redirect)
‚úÖ Same user data displayed

Check Network tab:
‚úÖ POST request to /graphql/ (refreshToken mutation)
‚úÖ Request includes cookies (refresh_token sent automatically)
‚úÖ Response returns new accessToken
```

---

#### Test C: Logout Cookie Clearing
```bash
1. Login successfully
2. Verify cookies exist in DevTools
3. Click "Logout" button
4. Check DevTools ‚Üí Application ‚Üí Cookies

Expected:
‚úÖ refresh_token: DELETED
‚úÖ client_fp: DELETED
‚úÖ fp_hash: DELETED
‚úÖ All auth cookies cleared

Check Console:
‚úÖ "üö™ Starting logout process..."
‚úÖ "‚úÖ Backend logout successful (cookies cleared by server)"
‚úÖ "üßπ Frontend state cleared"

Try accessing protected route:
‚úÖ Redirected to login page (401 Unauthorized)
```

---

#### Test D: Token Rotation on Refresh
```bash
1. Login successfully
2. Open DevTools ‚Üí Application ‚Üí Cookies
3. Copy refresh_token value (e.g., "eyJhbGci...")
4. Refresh page (F5)
5. Check refresh_token value again

Expected:
‚úÖ refresh_token value CHANGED (new token)
‚úÖ Old token was rotated (security)

Backend behavior:
‚úÖ Old refresh token added to blacklist
‚úÖ New refresh token generated
‚úÖ New access token returned
```

---

#### Test E: XSS Protection Verification
```bash
1. Login successfully
2. Open DevTools ‚Üí Console
3. Try to steal tokens (simulate XSS attack):

// Try to read access token from cookies
document.cookie.split('; ').find(row => row.startsWith('access_token='))
Expected: ‚ùå undefined (not in cookies)

// Try to read refresh token from cookies
document.cookie.split('; ').find(row => row.startsWith('refresh_token='))
Expected: ‚ùå undefined (HTTP-only, invisible to JS)

// Try to read from localStorage
localStorage.getItem('accessToken')
localStorage.getItem('refresh_token')
Expected: ‚ùå null (not stored there)

// Try to read from sessionStorage
sessionStorage.getItem('accessToken')
sessionStorage.getItem('refresh_token')
Expected: ‚ùå null (not stored there)

Result:
‚úÖ No way for malicious JavaScript to steal tokens
‚úÖ XSS attack cannot access authentication credentials
```

---

## üé¨ Video Recording Test (Recommended)

**Best practice**: Record your screen while testing for documentation.

```bash
1. Start screen recording (Windows: Win+G, Mac: Cmd+Shift+5)

2. Test Scenario 1: Session Cookie
   - Show login screen
   - Login WITHOUT Remember Me
   - Show DevTools cookies (no Expires field)
   - Close browser completely
   - Reopen browser
   - Show redirect to login (session ended)

3. Test Scenario 2: Persistent Cookie
   - Show login screen
   - Login WITH Remember Me
   - Show DevTools cookies (Expires ~30 days)
   - Close browser completely
   - Reopen browser
   - Show successful login restoration

4. Save recording as: remember_me_test_oct082025.mp4
```

---

## üêõ Troubleshooting Common Issues

### Issue 1: "refresh_token cookie not found"
**Symptom**: Session restoration fails, user redirected to login

**Debug Steps**:
```bash
1. Check if backend is setting cookies:
   - Backend logs should show: "üîê Setting SESSION/PERSISTENT cookies"
   - If not, check auth/mutation.py login function

2. Check CORS settings:
   - Frontend must use credentials: 'include' in fetch
   - Backend CORS_ALLOW_CREDENTIALS must be True
   - Backend CORS_ALLOWED_ORIGINS must include frontend URL

3. Check cookie domain:
   - Both frontend/backend on same domain (localhost)
   - Cookie path is '/' (not '/api' or other)
```

**Fix**:
```python
# Backend: config/settings/dev.py
CORS_ALLOW_CREDENTIALS = True
CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",  # Frontend URL
]
```

---

### Issue 2: "Cookies visible in document.cookie"
**Symptom**: Can see refresh_token value in JavaScript

**Debug Steps**:
```bash
1. Check if HttpOnly flag is set:
   DevTools ‚Üí Application ‚Üí Cookies ‚Üí Check "HttpOnly" column
   
2. If not HttpOnly:
   - Check auth/secure_utils.py set_secure_jwt_cookies()
   - Verify: httponly=True in response.set_cookie()

3. Verify cookies set by backend (not frontend):
   - Frontend should NEVER call document.cookie = 'refresh_token=...'
   - Only backend can create truly HTTP-only cookies
```

**Fix**:
```python
# Backend: auth/secure_utils.py
response.set_cookie(
    'refresh_token',
    refresh_token,
    httponly=True,  # ‚úÖ CRITICAL
    secure=not settings.DEBUG,
    samesite='Strict',
    path='/',
)
```

---

### Issue 3: "Session cookie persists after browser close"
**Symptom**: User stays logged in even with Remember Me = OFF

**Debug Steps**:
```bash
1. Check cookie max_age value:
   DevTools ‚Üí Application ‚Üí Cookies ‚Üí Check "Expires/Max-Age" column
   
2. If session cookie has Expires date:
   - Backend incorrectly setting max_age
   - Should be max_age=None (not 0, not empty string)

3. Check backend logs:
   - Should show: "üîê Setting SESSION cookies (browser close = logout)"
   - If shows "PERSISTENT", remember_me flag not passed correctly
```

**Fix**:
```python
# Backend: auth/secure_utils.py
if remember_me:
    max_age = int(settings.NINJA_JWT['REFRESH_TOKEN_LIFETIME_REMEMBER'].total_seconds())
else:
    max_age = None  # ‚úÖ CRITICAL: None = session cookie, NOT 0
```

---

### Issue 4: "Access token in localStorage"
**Symptom**: Security scan finds tokens in localStorage

**Debug Steps**:
```bash
1. Search codebase for localStorage.setItem:
   grep -r "localStorage.setItem.*[Tt]oken" skillsync-fe/

2. Check if old code still present:
   - Should be removed in Phase 1 (Oct 8, 2025)
   - Check AuthContext.tsx, signin.tsx, otp.tsx

3. Verify React state storage:
   - Only setAuthState({ accessToken: ... })
   - Never localStorage or sessionStorage
```

**Fix**: Remove any remaining localStorage calls:
```typescript
// ‚ùå REMOVE THIS
localStorage.setItem('accessToken', token);
localStorage.setItem('refreshToken', token);

// ‚úÖ USE THIS
setAuthState(prev => ({ ...prev, accessToken: token }));
```

---

## üìä Testing Checklist Summary

### Before Release:
- [ ] Backend test_remember_me.py passes (all 3 tests)
- [ ] Frontend login WITHOUT Remember Me ‚Üí browser close ‚Üí must re-login
- [ ] Frontend login WITH Remember Me ‚Üí browser close ‚Üí stays logged in
- [ ] Access token NOT in cookies/localStorage/sessionStorage (memory only)
- [ ] HTTP-only cookies NOT visible in document.cookie
- [ ] Logout clears all cookies (verify in DevTools)
- [ ] Session restoration works on page refresh (< 500ms)
- [ ] Token rotation works (refresh_token value changes on refresh)
- [ ] XSS protection verified (cannot steal tokens via JavaScript)
- [ ] CORS configured correctly (credentials included)
- [ ] Cookie attributes correct (HttpOnly, Secure in prod, SameSite=Strict)

### Performance:
- [ ] Login response time < 1 second
- [ ] Session restoration < 500ms
- [ ] Token refresh < 200ms
- [ ] Logout < 300ms

### Security:
- [ ] No tokens in browser DevTools ‚Üí Storage section
- [ ] No tokens accessible via document.cookie
- [ ] Backend logs show secure cookie setting
- [ ] HTTPS enforced in production (Secure flag = true)

---

## üéØ Quick Test Summary

**Fastest test (2 minutes)**:
```bash
1. Login WITHOUT Remember Me
2. Close browser completely
3. Reopen ‚Üí Should NOT be logged in ‚úÖ

4. Login WITH Remember Me
5. Close browser completely
6. Reopen ‚Üí Should STILL be logged in ‚úÖ
```

**That's it!** If those two scenarios pass, Remember Me is working correctly.

---

## üìù Test Results Template

Copy this to document your test results:

```markdown
# Remember Me Test Results - October 8, 2025

## Environment
- Backend: Django 4.x (localhost:8000)
- Frontend: Next.js 15.5.2 (localhost:3000)
- Browser: [Chrome/Firefox/Safari] [version]
- OS: [Windows/Mac/Linux]

## Test 1: Session Cookie (Remember Me = OFF)
- [ ] Login successful
- [ ] Cookies set (no Expires field)
- [ ] Browser close ‚Üí Session ended
- [ ] Reopen ‚Üí Must login again
- **Result**: ‚úÖ PASS / ‚ùå FAIL

## Test 2: Persistent Cookie (Remember Me = ON)
- [ ] Login successful
- [ ] Cookies set (Expires ~30 days)
- [ ] Browser close ‚Üí Cookie persists
- [ ] Reopen ‚Üí Session restored
- **Result**: ‚úÖ PASS / ‚ùå FAIL

## Test 3: Memory-Only Access Token
- [ ] Access token NOT in document.cookie
- [ ] Access token NOT in localStorage
- [ ] Access token NOT in sessionStorage
- [ ] Access token ONLY in React state
- **Result**: ‚úÖ PASS / ‚ùå FAIL

## Test 4: HTTP-Only Cookie Protection
- [ ] refresh_token has HttpOnly flag
- [ ] Cannot read refresh_token via JavaScript
- [ ] client_fp has HttpOnly flag
- [ ] fp_hash has HttpOnly flag
- **Result**: ‚úÖ PASS / ‚ùå FAIL

## Test 5: Logout Cookie Clearing
- [ ] Logout successful
- [ ] All cookies deleted
- [ ] Access to protected route blocked
- [ ] Must login again
- **Result**: ‚úÖ PASS / ‚ùå FAIL

## Overall Result
- **Total Tests**: 5
- **Passed**: [X]
- **Failed**: [X]
- **Status**: ‚úÖ READY FOR PRODUCTION / ‚ùå NEEDS FIXES

## Notes
[Any observations, issues, or recommendations]

## Tested By
Name: [Your Name]
Date: October 8, 2025
Time: [Time]
```

---

*Testing Guide Created: October 8, 2025*  
*For: Remember Me Feature Verification*  
*Security Level: Enterprise-Grade*
